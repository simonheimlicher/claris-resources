{{ $template := "claris/_functions/resources/images/process-image" }}
{{ $processedImg := false }}
{{ $page := default page .Page }}
{{ $debug := and false (or .Debug ($page.Param "clarisdebug") ) }}
{{ $dbg := printf "%s %q [%s]" (replaceRE `.*?((?:[^/]+/){,2})$` `$1` $page.RelPermalink) .resource (replaceRE `.*?([^/]+)$` `$1` $template) }}

{{ $img := .resource }}
{{ $originalRatio := false }}

{{ $processingArgNames := slice "resource" "format" "quality" }}
{{ $processImageArgs := (dict "Debug" $debug) }}
{{ range $k, $v := . }}
  {{ with and $v (in $processingArgNames $k) }}
    {{ $processImageArgs = merge $processImageArgs (dict $k $v) }}
  {{ end }}
{{ end }}

{{ if (strings.Contains (printf "%T" $img) "resources.resourceAdapter" ) }}

  {{ $imgPosition := default false .position }}

  {{ $dim := partial "claris/_functions/resources/images/parse-image-dimensions" . }}
  {{ $originalRatio = $dim.original.ratio }}
  {{ $targetWidth := $dim.target.width }}
  {{ $targetHeight := $dim.target.height }}
  {{ $targetRatio := $dim.target.ratio }}

  {{ $processImageArgs = merge $processImageArgs $dim.target }}

  {{ $aspectRatioTolerance := 0.0001 }}
  {{ $aspectRatioDeviation := false }}

  {{ if $targetRatio }}
    {{ $aspectRatioDeviation = math.Pow (sub (div $originalRatio $targetRatio) 1) 2 }}
  {{ end }}

  {{ if or (not $targetRatio) (lt $aspectRatioDeviation $aspectRatioTolerance) }}
    {{ if $debug }}
      {{ if $targetRatio }}
        {{ warnf "%s maintain aspect: aspectRatioDeviation=%v < %v, resize originalRatio=%v to targetRatio=%v"
            $dbg $aspectRatioDeviation $aspectRatioTolerance $originalRatio $targetRatio }}
      {{ else }}
        {{ warnf "%s maintain aspect: no targetRatio, keep originalRatio=%.4g"
            $dbg $originalRatio }}
      {{ end }}
    {{ end }}

    {{/* The aspect ratio remains the same, hence resize the image */}}

    {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
      "method" "Resize"
      "anchor" "Center"
    ) ) }}

    {{ if $debug }}
      {{ warnf "%s resized original, maintaining aspect ratio: [%dx%d, %.4g]-->[%dx%d, %.4g]"
          $dbg $img.Width $img.Height $originalRatio $processedImg.Width $processedImg.Height
          (div (cast.ToFloat $processedImg.Width) (cast.ToFloat $processedImg.Height) ) }}
    {{ end }}
    
  {{ else }}

    {{/* The aspect ratio changes, hence we crop the image either horizontally or vertically */}}

    {{ $ratioRatio := div $targetRatio $originalRatio }}

    {{ if $imgPosition }}

      {{/* Crop such that visible part as determined by the aspect ratio
            is consistent with the uncropped image */}} 

      {{ $posHorizontal := 0.5 }}
      {{ $posVertical := 0.5 }}
      {{ $imgPosComponents := slice }}
      {{ if reflect.IsSlice $imgPosition }}
        {{ $imgPosComponents = $imgPosition }}
      {{ else }}
        {{ $imgPosComponents = split $imgPosition " " }}
      {{ end }}

      {{ range $idx, $comp:= $imgPosComponents }}
        {{ with (trim $comp " ") | lower }}
          {{ if in (slice "left") . }}
            {{ $posHorizontal = 0 }}
          {{ else if in (slice "center") . }}
            {{ $posHorizontal = 0.5 }}
          {{ else if in (slice "right") . }}
            {{ $posHorizontal = 1 }}
          {{ else if in (slice "top") . }}
            {{ $posVertical = 0 }}
          {{ else if in (slice "center") . }}
            {{ $posVertical = 0.5 }}
          {{ else if in (slice "bottom") . }}
            {{ $posVertical = 1 }}
          {{ else if strings.HasSuffix . "%" }}
            {{ $posPercentage := div (strings.TrimRight "%" . | cast.ToFloat) 100 }}
            {{ if or (lt $posPercentage 0) (gt $posPercentage 1) }}
              {{ errorf "%s imgPosition=%v [%T]: component %v [idx=%d] represents an invalid posPercentage=%v [%T]"
                  $dbg $imgPosition $imgPosition $comp $idx $posPercentage $posPercentage }}
            {{ end }}
            {{ if eq $idx 0 }}
              {{ $posHorizontal = $posPercentage }}
            {{ else }}
              {{ $posVertical = $posPercentage }}
            {{ end }}
          {{ else }}
            {{ errorf `%sinvalid imgPosition=%v [%T]: component %v [idx=%d] is not in {top|center|bottom} or {left|center|right} and does not end with "%%"`
                $dbg $imgPosition $imgPosition $comp $idx $posVertical }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if $debug }}
        {{ warnf "%s crop %s as targetRatio = %v %v %v = original ratio (img.Width/img.Height)"
            $dbg (or (and (gt $ratioRatio 1.0) "horizontally") "vertically")
            $targetRatio (or (and (gt $ratioRatio 1.0) "<") ">") $originalRatio }}
      {{ end }}

      {{ if gt $ratioRatio 1.0 }}

        {{ $ratioHeight := div $img.Width $targetRatio }}
        {{ if $debug }}
          {{ warnf "%s posVertical=%v .Height=%v ratioHeight=%v targetHeight=%v"
              $dbg $posVertical $img.Height $ratioHeight $targetHeight }}
        {{ end }}

        {{ if eq $posVertical 0.0 }}
          {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
            "method" "Fill"
            "anchor" "Top"
          ) ) }}
        {{ else if eq $posVertical 1.0 }}
          {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
            "method" "Fill"
            "anchor" "Bottom"
          ) ) }}

        {{ else }}

          {{/* Crop with anchor set to Bottom, then fill with anchor set to Top */}}
        
          {{ $cropHeight := sub $img.Height (mul $posVertical (sub $img.Height $ratioHeight) ) | math.Round | cast.ToInt }}
    
          {{/* Crop from top */}}
          {{ $cropArgs := printf "%dx%d Bottom" $img.Width $cropHeight }}
          {{ if $debug }}
            {{ warnf "%s .Crop %v: posVertical=%v .Height=%v ratioHeight=%v"
                $dbg $cropArgs $posVertical $img.Height $ratioHeight }}
          {{ end }}
          {{ $processedImg = $img.Crop $cropArgs }}

          {{/* Fill from bottom */}}
          {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
            "resource" $processedImg
            "method" "Fill"
            "anchor" "Top"
          ) ) }}
        {{ end }}
  
      {{ else if lt $ratioRatio 1.0 }}

        {{ $ratioWidth := mul $img.Height $targetRatio }}
        {{ if $debug }}
          {{ warnf "%s posHorizontal=%v .Width=%v ratioWidth=%v targetWidth=%v"
              $dbg $posHorizontal $img.Width $ratioWidth $targetWidth }}
        {{ end }}

        {{ if eq $posHorizontal 0.0 }}
          {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
            "method" "Fill"
            "anchor" "Left"
          ) ) }}
        {{ else if eq $posHorizontal 1.0 }}
          {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
            "method" "Fill"
            "anchor" "Right"
          ) ) }}

        {{ else }}

          {{/* Crop with anchor set to Right, then fill with anchor set to Left */}}
        
          {{ $cropWidth := sub $img.Width (mul $posHorizontal (sub $img.Width $ratioWidth) ) | math.Round | cast.ToInt }}
    
          {{/* Crop from Left */}}
          {{ $cropArgs := printf "%dx%d Right" $cropWidth $img.Height }}
          {{ if $debug }}
            {{ warnf "%s .Crop %v: posHorizontal=%v .Width=%v ratioWidth=%v"
                $dbg $cropArgs $posHorizontal $img.Width $ratioWidth }}
          {{ end }}
          {{ $processedImg = $img.Crop $cropArgs }}

          {{/* Fill from Left */}}
          {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
            "resource" $processedImg
            "method" "Fill"
            "anchor" "Left"
          ) ) }}
        {{ end }}

      {{ else }}
        {{ warnf "%s ratioRatio=%v" $ratioRatio }}
        {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
          "method" "Fill"
          "anchor" "Center"
        ) ) }}
      {{ end }}

    {{ else }}

      {{/* .Fill with Hugo's `Smart` algorithm to determine the anchor of crop */}}

      {{ $processedImg = partial "claris/_functions/resources/images/process" (merge $processImageArgs (dict
        "method" "Fill"
        "anchor" "Smart"
      ) ) }}

    {{ end }}
  {{ end }}

{{ else }}

  {{ errorf `%s invalid .resource=%v [%T]: must be of type "*resources.resourceAdapter"` $dbg $img $img }}

{{ end }}

{{ if $debug }}
  {{ warnf "%s returning %v[%dx%d ratio=%.4g] from %v[%dx%d ratio=%.4g] with args: %#v" $dbg
      $processedImg.MediaType
      $processedImg.Width $processedImg.Height
      (div (cast.ToFloat $processedImg.Width) (cast.ToFloat $processedImg.Height) )
      $img.MediaType $img.Width $img.Height $originalRatio $processImageArgs }}
{{ end }}
{{ if not (strings.Contains (printf "%T" $processedImg) "resources.resourceAdapter" ) }}
  {{ errorf "%s invalid result: %T: %v" $dbg $processedImg $processedImg }}
{{ end }}
{{ return $processedImg }}

{{ define "partials/claris/_functions/resources/images/process" }}
  {{ $template := "claris/_functions/resources/images/process-image" }}
  {{ $page := default page .Page }}
  {{ $debug := and false (or .Debug ($page.Param "clarisdebug") ) }}
  {{ $dbg := printf "%s %q [%s]" (replaceRE `.*?((?:[^/]+/){,2})$` `$1` $page.RelPermalink) .resource (replaceRE `.*?([^/]+)$` `$1` $template) }}
  {{ $processedImg := .resource }}

  {{ if and ($img := .resource) ($processingMethod := lower .method) }}
  
    {{ $processingArgsList := slice }}
    
    {{ with .sizespec }}
      {{ $processingArgsList = append . $processingArgsList }}
    {{ end }}

    {{ with .anchor }}
      {{ $processingArgsList = append . $processingArgsList }}
    {{ end }}

    {{ with .format }}
      {{ $supportedFormats := slice "gif" "jpeg" "png" "tiff" "webp" }}
      {{ if in $supportedFormats . }}
        {{ $processingArgsList = append . $processingArgsList }}
      {{ else }}
        {{ errorf "%s invalid format: %q" $dbg . }}
      {{ end }}
    {{ end }}
    
    {{ with .quality }}
      {{ $processingArgsList = append (printf "q%d" .) $processingArgsList }}
    {{ end }}
    
    {{ with $processingArgsList }}
      {{ $processingArgs := delimit $processingArgsList " " }}

      {{ if $debug }}
        {{ warnf `%s .%s %q` $dbg (strings.FirstUpper $processingMethod) $processingArgs }}
      {{ end }}

      {{ if in (slice "resize") $processingMethod }}
        {{ $processedImg = $img.Resize $processingArgs }}
      {{ else if in (slice "fill") $processingMethod }}
        {{ $processedImg = $img.Fill $processingArgs }}
      {{ else if in (slice "crop") $processingMethod }}
        {{ $processedImg = $img.Crop $processingArgs }}
      {{ else }}
        {{ errorf "%s invalid arguments: .resource=%v: an image resource and .method=%v: name of a valid processing method: resize | fill | crop"
            $dbg .resource .method }}
      {{ end }}
    {{ else }}
      {{ errorf "%s .resource=%v .method=%v: nothing to do based on processing arguments:\n%v"
          $dbg .resource .method (jsonify (dict "indent" "  ") . ) }}
      {{ $processedImg = $img }}
    {{ end }}

  {{ else }}
    {{ errorf "%s required arguments: .resource=%v: an image resource and .method=%v: name of a valid processing method: resize | fill | crop"
        $dbg .resource .method }}
  {{ end }}
  {{ return $processedImg }}
{{ end }}
